"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function createCommonjsModule(t,e){return e={exports:{}},t(e,e.exports),e.exports}function resolveVariable(t,e){const r=e[t];if(void 0===r)throw new Error(`Could not find variable: ${t}`);return r.value}Object.defineProperty(exports,"__esModule",{value:!0});var fs=_interopDefault(require("fs")),path=_interopDefault(require("path")),Nodes={TABLE:"TABLE",JOIN:"JOIN",QUERY:"QUERY",QUERY_CALL:"QUERY_CALL",FIELD:"FIELD",RAW_TEXT:"RAW",OPERATION:"OPERATION",VARIABLE:"VARIABLE",BUILT_IN:"BUILT_IN",MUTATION:"MUTATION"},commonjsGlobal="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},_parser=createCommonjsModule(function(t,e){var r=function(){function t(){this.yy={}}var e=function(t,e,r,n){for(r=r||{},n=t.length;n--;r[t[n]]=e);return r},r=[1,5],n=[1,14],i=[1,8],o=[1,11],a=[1,13],s=[4,5,8,12,24,25,26,29,31,33,34,35,36,39,41,45],l=[1,19],u=[1,27],c=[24,26],h=[1,4,12,14,41],f=[4,12,41],d=[1,38],p=[1,48],_=[1,47],v=[1,58],y=[1,53],g=[1,59],m=[1,66],b=[24,26,34,36],k=[1,69],B=[4,8,31],O={trace:function(){},yy:{},symbols_:{error:2,Text:3,STRING:4,".":5,TextString:6,Number:7,NUMBER:8,Boolean:9,BOOLEAN:10,Join:11,JOIN_OP:12,Definition:13,DEFINITION:14,Root:15,DocumentList:16,Document:17,Variables:18,Block:19,QueryCall:20,Params:21,ParamList:22,Variable:23,",":24,"(":25,")":26,$:27,VariableList:28,"!":29,BuiltInFunc:30,"'":31,Equation:32,'"':33,OPERATOR:34,"[":35,"]":36,EquationList:37,Selectors:38,"{":39,BlockContent:40,"}":41,Content:42,JoinOperation:43,TableOperation:44,":":45,$accept:0,$end:1},terminals_:{2:"error",4:"STRING",5:".",8:"NUMBER",10:"BOOLEAN",12:"JOIN_OP",14:"DEFINITION",24:",",25:"(",26:")",27:"$",29:"!",31:"'",33:'"',34:"OPERATOR",35:"[",36:"]",39:"{",41:"}",45:":"},productions_:[0,[3,1],[3,3],[6,1],[6,1],[6,2],[6,2],[7,1],[9,1],[11,1],[13,1],[15,1],[17,4],[17,3],[16,2],[16,1],[20,2],[22,0],[22,1],[22,1],[22,1],[22,1],[22,3],[22,3],[21,3],[23,2],[18,2],[18,3],[28,1],[28,2],[28,3],[28,4],[30,4],[32,1],[32,3],[32,1],[32,1],[32,1],[32,1],[32,3],[32,3],[32,3],[37,1],[37,3],[38,3],[19,3],[19,2],[40,1],[40,2],[42,1],[42,1],[42,1],[42,4],[42,3],[42,5],[42,3],[42,3],[42,3],[44,3],[44,2],[43,4]],performAction:function(t,e,r,n,i,o,a){var s=o.length-1;switch(i){case 1:case 3:case 4:case 8:case 9:case 10:case 25:case 37:case 49:case 50:this.$=o[s];break;case 2:this.$=o[s-2]+"."+o[s];break;case 5:case 6:this.$=o[s-1]+" "+o[s];break;case 7:this.$=Number(o[s]);break;case 11:return this.$=o[s];case 12:this.$={type:o[s-3].toUpperCase(),name:o[s-2],variables:o[s-1],nodes:o[s]};break;case 13:this.$={type:o[s-2].toUpperCase(),name:o[s-1],variables:[],nodes:o[s]};break;case 14:case 48:this.$=o[s-1],o[s-1].push(o[s]);break;case 15:case 42:case 47:this.$=[o[s]];break;case 16:this.$={type:"QUERY_CALL",name:o[s-1],params:o[s]};break;case 17:this.$=[""];break;case 18:this.$=[{type:"TEXT",value:o[s]}];break;case 19:this.$=[{type:"NUMBER",value:o[s]}];break;case 20:this.$=[{type:"BOOLEAN",value:o[s]}];break;case 21:this.$=[{type:"VARIABLE",value:o[s]}];break;case 22:case 23:case 43:this.$=o[s-2],o[s-2].push(o[s]);break;case 24:case 27:case 40:case 41:case 44:case 45:this.$=o[s-1];break;case 26:case 46:this.$=[];break;case 28:this.$=[{required:!1,name:o[s]}];break;case 29:this.$=[{required:!0,name:o[s-1]}];break;case 30:this.$=o[s-2],o[s-2].push({required:!1,name:o[s]});break;case 31:this.$=o[s-3],o[s-3].push({required:!0,name:o[s-1]});break;case 32:this.$=o[s-3]+" '"+o[s-1]+"'";break;case 33:this.$={type:"RAW",value:o[s]};break;case 34:this.$={type:"TEXT",value:o[s-1]};break;case 35:this.$={type:"NUMBER",value:o[s]};break;case 36:this.$={type:"VARIABLE",value:o[s]};break;case 38:this.$={type:"BUILT_IN",value:o[s]};break;case 39:this.$={type:"OPERATION",a:o[s-2],op:o[s-1],b:o[s]};break;case 51:this.$={type:"FIELD",name:o[s],value:null,alias:null};break;case 52:this.$={type:"FIELD",name:o[s-3],value:null,alias:o[s-1]};break;case 53:this.$={type:"FIELD",name:o[s-2],value:{type:"BOOLEAN",value:"true"===o[s]},alias:null};break;case 54:this.$={type:"FIELD",name:o[s-4],value:{type:"TEXT",value:o[s-1]},alias:null};break;case 55:this.$={type:"FIELD",name:o[s-2],value:{type:"RAW",value:o[s]},alias:null};break;case 56:this.$={type:"FIELD",name:o[s-2],value:{type:"NUMBER",value:o[s]},alias:null};break;case 57:this.$={type:"FIELD",name:o[s-2],value:{type:"VARIABLE",value:o[s]},alias:null};break;case 58:this.$={type:"TABLE",name:o[s-2].trim(),params:o[s-1],nodes:o[s]};break;case 59:this.$={type:"TABLE",name:o[s-1].trim(),params:[],nodes:o[s]};break;case 60:this.$={type:"JOIN",table:o[s-2].trim(),on:o[s-1],nodes:o[s]}}},table:[{13:4,14:r,15:1,16:2,17:3},{1:[3]},{1:[2,11],13:4,14:r,17:6},e(n,[2,15]),{3:7,4:i},{4:[2,10]},e(n,[2,14]),{5:o,18:9,19:10,25:[1,12],39:a},e(s,[2,1]),{19:14,39:a},e(n,[2,13]),{4:[1,15]},{23:18,26:[1,16],27:l,28:17},{3:25,4:i,11:26,12:u,40:20,41:[1,21],42:22,43:23,44:24},e(n,[2,12]),e(s,[2,2]),{39:[2,26]},{24:[1,29],26:[1,28]},e(c,[2,28],{29:[1,30]}),{3:31,4:i},{3:25,4:i,11:26,12:u,41:[1,32],42:33,43:23,44:24},e(h,[2,46]),e(f,[2,47]),e(f,[2,49]),e(f,[2,50]),e(f,[2,51],{38:36,19:37,5:o,25:d,35:[1,34],39:a,45:[1,35]}),{3:39,4:i},{4:[2,9]},{39:[2,27]},{23:40,27:l},e(c,[2,29]),e([4,12,24,26,29,34,36,41],[2,25],{5:o}),e(h,[2,45]),e(f,[2,48]),{3:41,4:i},{3:44,4:i,7:45,8:p,9:42,10:_,23:46,27:l,33:[1,43]},{19:49,39:a},e(f,[2,59]),{3:52,4:i,7:54,8:p,20:56,23:55,25:v,27:l,30:57,32:51,33:y,35:g,37:50},{5:o,25:d,38:60},e(c,[2,30],{29:[1,61]}),{5:o,36:[1,62]},e(f,[2,53]),{3:63,4:i},e(f,[2,55],{5:o}),e(f,[2,56]),e(f,[2,57]),e([4,12,24,26,41],[2,8]),e([4,8,12,24,26,31,34,36,41],[2,7]),e(f,[2,58]),{24:[1,65],26:[1,64]},e(c,[2,42],{34:m}),e(b,[2,33],{21:67,5:o,25:k,31:[1,68]}),{3:70,4:i},e(b,[2,35]),e(b,[2,36]),e(b,[2,37]),e(b,[2,38]),{3:52,4:i,7:54,8:p,20:56,23:55,25:v,27:l,30:57,32:71,33:y,35:g},{3:52,4:i,7:54,8:p,20:56,23:55,25:v,27:l,30:57,32:72,33:y,35:g},{19:73,39:a},e(c,[2,31]),e(f,[2,52]),{5:o,33:[1,74]},{39:[2,44]},{3:52,4:i,7:54,8:p,20:56,23:55,25:v,27:l,30:57,32:75,33:y,35:g},{3:52,4:i,7:54,8:p,20:56,23:55,25:v,27:l,30:57,32:76,33:y,35:g},e(b,[2,16]),{3:78,4:i,6:77,7:79,8:p},e(c,[2,17],{22:80,3:81,7:82,9:83,23:84,4:i,8:p,10:_,27:l}),{5:o,33:[1,85]},{26:[1,86],34:m},{34:m,36:[1,87]},e(f,[2,60]),e(f,[2,54]),e(c,[2,43],{34:m}),e([24,26,36],[2,39],{34:m}),{3:90,4:i,7:89,8:p,31:[1,88]},e(B,[2,3],{5:o}),e(B,[2,4]),{24:[1,92],26:[1,91]},e(c,[2,18],{5:o}),e(c,[2,19]),e(c,[2,20]),e(c,[2,21]),e(b,[2,34]),e(b,[2,40]),e(b,[2,41]),e(b,[2,32]),e(B,[2,5]),e(B,[2,6],{5:o}),e(b,[2,24]),{3:94,4:i,20:93},e(c,[2,22]),e(c,[2,23],{21:67,5:o,25:k})],defaultActions:{5:[2,10],16:[2,26],27:[2,9],28:[2,27],64:[2,44]},parseError:function(t,e){if(!e.recoverable){var r=new Error(t);throw r.hash=e,r}this.trace(t)},parse:function(t){var e=this,r=[0],n=[null],i=[],o=this.table,a="",s=0,l=0,u=i.slice.call(arguments,1),c=Object.create(this.lexer),h={yy:{}};for(var f in this.yy)Object.prototype.hasOwnProperty.call(this.yy,f)&&(h.yy[f]=this.yy[f]);c.setInput(t,h.yy),h.yy.lexer=c,h.yy.parser=this,void 0===c.yylloc&&(c.yylloc={});var d=c.yylloc;i.push(d);var p=c.options&&c.options.ranges;"function"==typeof h.yy.parseError?this.parseError=h.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var _,v,y,g,m,b,k,B,O,w=function(){var t;return"number"!=typeof(t=c.lex()||1)&&(t=e.symbols_[t]||t),t},P={};;){if(y=r[r.length-1],this.defaultActions[y]?g=this.defaultActions[y]:(null!==_&&void 0!==_||(_=w()),g=o[y]&&o[y][_]),void 0===g||!g.length||!g[0]){var E="";O=[];for(b in o[y])this.terminals_[b]&&b>2&&O.push("'"+this.terminals_[b]+"'");E=c.showPosition?"Parse error on line "+(s+1)+":\n"+c.showPosition()+"\nExpecting "+O.join(", ")+", got '"+(this.terminals_[_]||_)+"'":"Parse error on line "+(s+1)+": Unexpected "+(1==_?"end of input":"'"+(this.terminals_[_]||_)+"'"),this.parseError(E,{text:c.match,token:this.terminals_[_]||_,line:c.yylineno,loc:d,expected:O})}if(g[0]instanceof Array&&g.length>1)throw new Error("Parse Error: multiple actions possible at state: "+y+", token: "+_);switch(g[0]){case 1:r.push(_),n.push(c.yytext),i.push(c.yylloc),r.push(g[1]),_=null,v?(_=v,v=null):(l=c.yyleng,a=c.yytext,s=c.yylineno,d=c.yylloc);break;case 2:if(k=this.productions_[g[1]][1],P.$=n[n.length-k],P._$={first_line:i[i.length-(k||1)].first_line,last_line:i[i.length-1].last_line,first_column:i[i.length-(k||1)].first_column,last_column:i[i.length-1].last_column},p&&(P._$.range=[i[i.length-(k||1)].range[0],i[i.length-1].range[1]]),void 0!==(m=this.performAction.apply(P,[a,l,s,h.yy,g[1],n,i].concat(u))))return m;k&&(r=r.slice(0,-1*k*2),n=n.slice(0,-1*k),i=i.slice(0,-1*k)),r.push(this.productions_[g[1]][0]),n.push(P.$),i.push(P._$),B=o[r[r.length-2]][r[r.length-1]],r.push(B);break;case 3:return!0}}return!0}},w={EOF:1,parseError:function(t,e){if(!this.yy.parser)throw new Error(t);this.yy.parser.parseError(t,e)},setInput:function(t,e){return this.yy=e||this.yy||{},this._input=t,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var t=this._input[0];return this.yytext+=t,this.yyleng++,this.offset++,this.match+=t,this.matched+=t,t.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),t},unput:function(t){var e=t.length,r=t.split(/(?:\r\n?|\n)/g);this._input=t+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-e),this.offset-=e;var n=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),r.length-1&&(this.yylineno-=r.length-1);var i=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:r?(r.length===n.length?this.yylloc.first_column:0)+n[n.length-r.length].length-r[0].length:this.yylloc.first_column-e},this.options.ranges&&(this.yylloc.range=[i[0],i[0]+this.yyleng-e]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(t){this.unput(this.match.slice(t))},pastInput:function(){var t=this.matched.substr(0,this.matched.length-this.match.length);return(t.length>20?"...":"")+t.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var t=this.match;return t.length<20&&(t+=this._input.substr(0,20-t.length)),(t.substr(0,20)+(t.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var t=this.pastInput(),e=new Array(t.length+1).join("-");return t+this.upcomingInput()+"\n"+e+"^"},test_match:function(t,e){var r,n,i;if(this.options.backtrack_lexer&&(i={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(i.yylloc.range=this.yylloc.range.slice(0))),(n=t[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=n.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:n?n[n.length-1].length-n[n.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+t[0].length},this.yytext+=t[0],this.match+=t[0],this.matches=t,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(t[0].length),this.matched+=t[0],r=this.performAction.call(this,this.yy,this,e,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),r)return r;if(this._backtrack){for(var o in i)this[o]=i[o];return!1}return!1},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var t,e,r,n;this._more||(this.yytext="",this.match="");for(var i=this._currentRules(),o=0;o<i.length;o++)if((r=this._input.match(this.rules[i[o]]))&&(!e||r[0].length>e[0].length)){if(e=r,n=o,this.options.backtrack_lexer){if(!1!==(t=this.test_match(r,i[o])))return t;if(this._backtrack){e=!1;continue}return!1}if(!this.options.flex)break}return e?!1!==(t=this.test_match(e,i[n]))&&t:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var t=this.next();return t||this.lex()},begin:function(t){this.conditionStack.push(t)},popState:function(){return this.conditionStack.length-1>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(t){return(t=this.conditionStack.length-1-Math.abs(t||0))>=0?this.conditionStack[t]:"INITIAL"},pushState:function(t){this.begin(t)},stateStackSize:function(){return this.conditionStack.length},options:{},performAction:function(t,e,r,n){switch(r){case 0:break;case 1:return 8;case 2:return 14;case 3:return 10;case 4:return 4;case 5:return 34;case 6:return 39;case 7:return 41;case 8:return 25;case 9:return 26;case 10:return 12;case 11:return 24;case 12:return"'";case 13:return 33;case 14:return 5;case 15:return 27;case 16:return 35;case 17:return 36;case 18:return 45;case 19:return 29}},rules:[/^(?:\s+)/,/^(?:\d+\b)/,/^(?:query|mutation\b)/,/^(?:false|true\b)/,/^(?:[\w\_\d]+)/,/^(?:([\+\-*\/%&|^=><]+)|(![=<>]+))/,/^(?:\{)/,/^(?:\})/,/^(?:\()/,/^(?:\))/,/^(?:\.{3}\s*on\b)/,/^(?:,)/,/^(?:')/,/^(?:")/,/^(?:\.)/,/^(?:\$)/,/^(?:\[)/,/^(?:\])/,/^(?::)/,/^(?:!)/],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19],inclusive:!0}}};return O.lexer=w,t.prototype=O,O.Parser=t,new t}();void 0!==commonjsRequire&&(e.parser=r,e.Parser=r.Parser,e.parse=function(){return r.parse.apply(r,arguments)},e.main=function(t){t[1]||(console.log("Usage: "+t[0]+" FILE"),process.exit(1));var r=fs.readFileSync(path.normalize(t[1]),"utf8");return e.parser.parse(r)},commonjsRequire.main===t&&e.main(process.argv.slice(1)))}),squel=createCommonjsModule(function(t,e){!function(e,r){t.exports=r()}(0,function(){function t(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function e(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){return t.length?t+e:t}function i(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];if(t&&r){var i=!0,o=!1,a=void 0;try{for(var s,l=function(){var e=s.value;"object"===(void 0===e?"undefined":p(e))&&Object.getOwnPropertyNames(e).forEach(function(r){t[r]=e[r]})},u=r[Symbol.iterator]();!(i=(s=u.next()).done);i=!0)l()}catch(t){o=!0,a=t}finally{try{!i&&u.return&&u.return()}finally{if(o)throw a}}}return t}function o(t){return t&&t.constructor.prototype===Object.prototype}function a(t){return t&&t.constructor.prototype===Array.prototype}function s(t){if(!t)return t;if("function"==typeof t.clone)return t.clone();if(o(t)||a(t)){var e=new t.constructor;return Object.getOwnPropertyNames(t).forEach(function(r){"function"!=typeof t[r]&&(e[r]=s(t[r]))}),e}return JSON.parse(JSON.stringify(t))}function l(t,e,r){var n=void 0===e?"undefined":p(e);if("function"!==n&&"string"!==n)throw new Error("type must be a class constructor or string");if("function"!=typeof r)throw new Error("handler must be a function");var i=!0,o=!1,a=void 0;try{for(var s,l=t[Symbol.iterator]();!(i=(s=l.next()).done);i=!0){var u=s.value;if(u.type===e)return void(u.handler=r)}}catch(t){o=!0,a=t}finally{try{!i&&l.return&&l.return()}finally{if(o)throw a}}t.push({type:e,handler:r})}function u(t,e,r){return c(t,e)||c(t,r)}function c(t,e){for(var r=0;r<e.length;r++){var n=e[r];if((void 0===t?"undefined":p(t))===n.type||"string"!=typeof n.type&&t instanceof n.type)return n.handler}}function h(){var c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,h={isSquelBuilder:function(t){return t&&!!t._toParamString}},_=function(t){return!h.isSquelBuilder(t)||!t.options.rawNesting};h.DefaultQueryBuilderOptions={autoQuoteTableNames:!1,autoQuoteFieldNames:!1,autoQuoteAliasNames:!0,useAsForTableAliasNames:!1,nameQuoteCharacter:"`",tableAliasQuoteCharacter:"`",fieldAliasQuoteCharacter:'"',valueHandlers:[],parameterCharacter:"?",numberedParameters:!1,numberedParametersPrefix:"$",numberedParametersStartAt:1,replaceSingleQuotes:!1,singleQuoteReplacement:"''",separator:" ",stringFormatter:null,rawNesting:!1},h.globalValueHandlers=[],h.registerValueHandler=function(t,e){l(h.globalValueHandlers,t,e)},h.Cloneable=function(){function t(){r(this,t)}return d(t,[{key:"clone",value:function(){return i(new this.constructor,s(i({},this)))}}]),t}(),h.BaseBuilder=function(n){function o(e){r(this,o);var n=t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this)),a=JSON.parse(JSON.stringify(h.DefaultQueryBuilderOptions));return["stringFormatter"].forEach(function(t){a[t]=h.DefaultQueryBuilderOptions[t]}),n.options=i({},a,e),n}return e(o,h.Cloneable),d(o,[{key:"registerValueHandler",value:function(t,e){return l(this.options.valueHandlers,t,e),this}},{key:"_sanitizeExpression",value:function(t){if(!h.isSquelBuilder(t)&&"string"!=typeof t)throw new Error("expression must be a stringÂ or builder instance");return t}},{key:"_sanitizeName",value:function(t,e){if("string"!=typeof t)throw new Error(e+" must be a string");return t}},{key:"_sanitizeField",value:function(t){return h.isSquelBuilder(t)||(t=this._sanitizeName(t,"field name")),t}},{key:"_sanitizeBaseBuilder",value:function(t){if(h.isSquelBuilder(t))return t;throw new Error("must be a builder instance")}},{key:"_sanitizeTable",value:function(t){if("string"!=typeof t)try{t=this._sanitizeBaseBuilder(t)}catch(t){throw new Error("table name must be a string or a builder")}else t=this._sanitizeName(t,"table");return t}},{key:"_sanitizeTableAlias",value:function(t){return this._sanitizeName(t,"table alias")}},{key:"_sanitizeFieldAlias",value:function(t){return this._sanitizeName(t,"field alias")}},{key:"_sanitizeLimitOffset",value:function(t){if(0>(t=parseInt(t))||isNaN(t))throw new Error("limit/offset must be >= 0");return t}},{key:"_sanitizeValue",value:function(t){var e=void 0===t?"undefined":p(t);if(null===t);else if("string"===e||"number"===e||"boolean"===e);else if(h.isSquelBuilder(t));else if(!!!u(t,this.options.valueHandlers,h.globalValueHandlers))throw new Error("field value must be a string, number, boolean, null or one of the registered custom value types");return t}},{key:"_escapeValue",value:function(t){return this.options.replaceSingleQuotes?t.replace(/\'/g,this.options.singleQuoteReplacement):t}},{key:"_formatTableName",value:function(t){if(this.options.autoQuoteTableNames){var e=this.options.nameQuoteCharacter;t=""+e+t+e}return t}},{key:"_formatFieldAlias",value:function(t){if(this.options.autoQuoteAliasNames){var e=this.options.fieldAliasQuoteCharacter;t=""+e+t+e}return t}},{key:"_formatTableAlias",value:function(t){if(this.options.autoQuoteAliasNames){var e=this.options.tableAliasQuoteCharacter;t=""+e+t+e}return this.options.useAsForTableAliasNames?"AS "+t:t}},{key:"_formatFieldName",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.options.autoQuoteFieldNames){var r=this.options.nameQuoteCharacter;t=e.ignorePeriodsForFieldNameQuotes?""+r+t+r:t.split(".").map(function(t){return"*"===t?t:""+r+t+r}).join(".")}return t}},{key:"_formatCustomValue",value:function(t,e,r){var n=u(t,this.options.valueHandlers,h.globalValueHandlers);return n&&(t=n(t,e,r))&&t.rawNesting?{formatted:!0,rawNesting:!0,value:t.value}:{formatted:!!n,value:t}}},{key:"_formatValueForParamArray",value:function(t){var e=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return a(t)?t.map(function(t){return e._formatValueForParamArray(t,r)}):this._formatCustomValue(t,!0,r).value}},{key:"_formatValueForQueryString",value:function(t){var e=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this._formatCustomValue(t,!1,r),i=n.rawNesting,o=n.formatted,s=n.value;if(o)return i?s:this._applyNestingFormatting(s,_(t));if(a(s))s=s.map(function(t){return e._formatValueForQueryString(t)}),s=this._applyNestingFormatting(s.join(", "),_(s));else{var l=void 0===s?"undefined":p(s);if(null===s)s="NULL";else if("boolean"===l)s=s?"TRUE":"FALSE";else if(h.isSquelBuilder(s))s=this._applyNestingFormatting(s.toString(),_(s));else if("number"!==l){if("string"===l&&this.options.stringFormatter)return this.options.stringFormatter(s);s=r.dontQuote?""+s:"'"+this._escapeValue(s)+"'"}}return s}},{key:"_applyNestingFormatting",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(t&&"string"==typeof t&&e&&!this.options.rawNesting){var r="("===t.charAt(0)&&")"===t.charAt(t.length-1);if(r)for(var n=0,i=1;t.length-1>++n;){var o=t.charAt(n);if("("===o)i++;else if(")"===o&&1>--i){r=!1;break}}r||(t="("+t+")")}return t}},{key:"_buildString",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=r.nested,i=r.buildParameterized,o=r.formattingOptions;e=e||[],t=t||"";for(var s="",l=-1,u=[],c=this.options.parameterCharacter,f=0;t.length>f;)if(t.substr(f,c.length)===c){var d=e[++l];if(i)if(h.isSquelBuilder(d)){var p=d._toParamString({buildParameterized:i,nested:!0});s+=p.text,p.values.forEach(function(t){return u.push(t)})}else a(d=this._formatValueForParamArray(d,o))?(s+="("+d.map(function(){return c}).join(", ")+")",d.forEach(function(t){return u.push(t)})):(s+=c,u.push(d));else s+=this._formatValueForQueryString(d,o);f+=c.length}else s+=t.charAt(f),f++;return{text:this._applyNestingFormatting(s,!!n),values:u}}},{key:"_buildManyStrings",value:function(t,e){for(var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=[],i=[],o=0;t.length>o;++o){var a=t[o],s=e[o],l=this._buildString(a,s,{buildParameterized:r.buildParameterized,nested:!1}),u=l.text,c=l.values;n.push(u),c.forEach(function(t){return i.push(t)})}return n=n.join(this.options.separator),{text:n.length?this._applyNestingFormatting(n,!!r.nested):"",values:i}}},{key:"_toParamString",value:function(t){throw new Error("Not yet implemented")}},{key:"toString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this._toParamString(t).text}},{key:"toParam",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this._toParamString(i({},t,{buildParameterized:!0}))}}]),o}(),h.Expression=function(n){function i(e){r(this,i);var n=t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return n._nodes=[],n}return e(i,h.BaseBuilder),d(i,[{key:"and",value:function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return t=this._sanitizeExpression(t),this._nodes.push({type:"AND",expr:t,para:r}),this}},{key:"or",value:function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return t=this._sanitizeExpression(t),this._nodes.push({type:"OR",expr:t,para:r}),this}},{key:"_toParamString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=[],r=[],n=!0,i=!1,o=void 0;try{for(var a,s=this._nodes[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var l=a.value,u=l.type,c=l.expr,f=l.para,d=h.isSquelBuilder(c)?c._toParamString({buildParameterized:t.buildParameterized,nested:!0}):this._buildString(c,f,{buildParameterized:t.buildParameterized}),p=d.text,_=d.values;e.length&&e.push(u),e.push(p),_.forEach(function(t){return r.push(t)})}}catch(t){i=!0,o=t}finally{try{!n&&s.return&&s.return()}finally{if(i)throw o}}return e=e.join(" "),{text:this._applyNestingFormatting(e,!!t.nested),values:r}}}]),i}(),h.Case=function(a){function s(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r(this,s);var a=t(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,n));return o(e)&&(n=e,e=null),e&&(a._fieldName=a._sanitizeField(e)),a.options=i({},h.DefaultQueryBuilderOptions,n),a._cases=[],a._elseValue=null,a}return e(s,h.BaseBuilder),d(s,[{key:"when",value:function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return this._cases.unshift({expression:t,values:r||[]}),this}},{key:"then",value:function(t){if(0==this._cases.length)throw new Error("when() needs to be called first");return this._cases[0].result=t,this}},{key:"else",value:function(t){return this._elseValue=t,this}},{key:"_toParamString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e="",r=[],i=!0,o=!1,a=void 0;try{for(var s,l=this._cases[Symbol.iterator]();!(i=(s=l.next()).done);i=!0){var u=s.value,c=u.expression,h=u.values,f=u.result;e=n(e," ");var d=this._buildString(c,h,{buildParameterized:t.buildParameterized,nested:!0});e+="WHEN "+d.text+" THEN "+this._formatValueForQueryString(f),d.values.forEach(function(t){return r.push(t)})}}catch(t){o=!0,a=t}finally{try{!i&&l.return&&l.return()}finally{if(o)throw a}}return e.length?(e+=" ELSE "+this._formatValueForQueryString(this._elseValue)+" END",this._fieldName&&(e=this._fieldName+" "+e),e="CASE "+e):e=this._formatValueForQueryString(this._elseValue),{text:e,values:r}}}]),s}(),h.Block=function(n){function i(e){return r(this,i),t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e))}return e(i,h.BaseBuilder),d(i,[{key:"exposedMethods",value:function(){for(var t={},e=this;e;)Object.getOwnPropertyNames(e).forEach(function(r){"constructor"===r||"function"!=typeof e[r]||"_"===r.charAt(0)||h.Block.prototype[r]||(t[r]=e[r])}),e=Object.getPrototypeOf(e);return t}}]),i}(),h.StringBlock=function(n){function i(e,n){r(this,i);var o=t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return o._str=n,o}return e(i,h.Block),d(i,[{key:"_toParamString",value:function(){return{text:this._str,values:[]}}}]),i}(),h.FunctionBlock=function(n){function i(e){r(this,i);var n=t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return n._strings=[],n._values=[],n}return e(i,h.Block),d(i,[{key:"function",value:function(t){this._strings.push(t);for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];this._values.push(r)}},{key:"_toParamString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this._buildManyStrings(this._strings,this._values,t)}}]),i}(),h.registerValueHandler(h.FunctionBlock,function(t){return arguments.length>1&&void 0!==arguments[1]&&arguments[1]?t.toParam():t.toString()}),h.AbstractTableBlock=function(i){function o(e,n){r(this,o);var i=t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return i._tables=[],i}return e(o,h.Block),d(o,[{key:"_table",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;e=e?this._sanitizeTableAlias(e):e,t=this._sanitizeTable(t),this.options.singleTable&&(this._tables=[]),this._tables.push({table:t,alias:e})}},{key:"_hasTable",value:function(){return 0<this._tables.length}},{key:"_toParamString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e="",r=[];if(this._hasTable()){var i=!0,o=!1,a=void 0;try{for(var s,l=this._tables[Symbol.iterator]();!(i=(s=l.next()).done);i=!0){var u=s.value,c=u.table,f=u.alias;e=n(e,", ");var d=void 0;if(h.isSquelBuilder(c)){var p=c._toParamString({buildParameterized:t.buildParameterized,nested:!0});d=p.text,p.values.forEach(function(t){return r.push(t)})}else d=this._formatTableName(c);f&&(d+=" "+this._formatTableAlias(f)),e+=d}}catch(t){o=!0,a=t}finally{try{!i&&l.return&&l.return()}finally{if(o)throw a}}this.options.prefix&&(e=this.options.prefix+" "+e)}return{text:e,values:r}}}]),o}(),h.TargetTableBlock=function(n){function i(){return r(this,i),t(this,(i.__proto__||Object.getPrototypeOf(i)).apply(this,arguments))}return e(i,h.AbstractTableBlock),d(i,[{key:"target",value:function(t){this._table(t)}}]),i}(),h.UpdateTableBlock=function(n){function i(){return r(this,i),t(this,(i.__proto__||Object.getPrototypeOf(i)).apply(this,arguments))}return e(i,h.AbstractTableBlock),d(i,[{key:"table",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._table(t,e)}},{key:"_toParamString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this._hasTable())throw new Error("table() needs to be called");return f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"_toParamString",this).call(this,t)}}]),i}(),h.FromTableBlock=function(n){function o(e){return r(this,o),t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,i({},e,{prefix:"FROM"})))}return e(o,h.AbstractTableBlock),d(o,[{key:"from",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._table(t,e)}}]),o}(),h.IntoTableBlock=function(n){function o(e){return r(this,o),t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,i({},e,{prefix:"INTO",singleTable:!0})))}return e(o,h.AbstractTableBlock),d(o,[{key:"into",value:function(t){this._table(t)}},{key:"_toParamString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this._hasTable())throw new Error("into() needs to be called");return f(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"_toParamString",this).call(this,t)}}]),o}(),h.GetFieldBlock=function(i){function o(e){r(this,o);var n=t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return n._fields=[],n}return e(o,h.Block),d(o,[{key:"fields",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(a(t)){var r=!0,n=!1,i=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var l=o.value;this.field(l,null,e)}}catch(t){n=!0,i=t}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}}else for(var u in t){var c=t[u];this.field(u,c,e)}}},{key:"field",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(e=e?this._sanitizeFieldAlias(e):e,t=this._sanitizeField(t),this._fields.filter(function(r){return r.name===t&&r.alias===e}).length)return this;this._fields.push({name:t,alias:e,options:r})}},{key:"_toParamString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.queryBuilder,r=t.buildParameterized,i="",o=[],a=!0,s=!1,l=void 0;try{for(var u,c=this._fields[Symbol.iterator]();!(a=(u=c.next()).done);a=!0){var f=u.value;i=n(i,", ");var d=f.name,p=f.alias,_=f.options;if("string"==typeof d)i+=this._formatFieldName(d,_);else{var v=d._toParamString({nested:!0,buildParameterized:r});i+=v.text,v.values.forEach(function(t){return o.push(t)})}p&&(i+=" AS "+this._formatFieldAlias(p))}}catch(t){s=!0,l=t}finally{try{!a&&c.return&&c.return()}finally{if(s)throw l}}if(!i.length){var y=e&&e.getBlock(h.FromTableBlock);y&&y._hasTable()&&(i="*")}return{text:i,values:o}}}]),o}(),h.AbstractSetFieldBlock=function(n){function i(e){r(this,i);var n=t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return n._reset(),n}return e(i,h.Block),d(i,[{key:"_reset",value:function(){this._fields=[],this._values=[[]],this._valueOptions=[[]]}},{key:"_set",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(this._values.length>1)throw new Error("Cannot set multiple rows of fields this way.");void 0!==e&&(e=this._sanitizeValue(e)),t=this._sanitizeField(t);var n=this._fields.indexOf(t);-1===n&&(this._fields.push(t),n=this._fields.length-1),this._values[0][n]=e,this._valueOptions[0][n]=r}},{key:"_setFields",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("object"!==(void 0===t?"undefined":p(t)))throw new Error("Expected an object but got "+(void 0===t?"undefined":p(t)));for(var r in t)this._set(r,t[r],e)}},{key:"_setFieldsRows",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!a(t))throw new Error("Expected an array of objects but got "+(void 0===t?"undefined":p(t)));this._reset();for(var r=0;t.length>r;++r){var n=t[r];for(var i in n){var o=n[i];i=this._sanitizeField(i),o=this._sanitizeValue(o);var s=this._fields.indexOf(i);if(0<r&&-1===s)throw new Error("All fields in subsequent rows must match the fields in the first row");-1===s&&(this._fields.push(i),s=this._fields.length-1),a(this._values[r])||(this._values[r]=[],this._valueOptions[r]=[]),this._values[r][s]=o,this._valueOptions[r][s]=e}}}}]),i}(),h.SetFieldBlock=function(i){function o(){return r(this,o),t(this,(o.__proto__||Object.getPrototypeOf(o)).apply(this,arguments))}return e(o,h.AbstractSetFieldBlock),d(o,[{key:"set",value:function(t,e,r){this._set(t,e,r)}},{key:"setFields",value:function(t,e){this._setFields(t,e)}},{key:"_toParamString",value:function(){var t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).buildParameterized;if(0>=this._fields.length)throw new Error("set() needs to be called");for(var e="",r=[],i=0;i<this._fields.length;++i){e=n(e,", ");var o=this._formatFieldName(this._fields[i]),a=this._values[0][i];0>o.indexOf("=")&&(o=o+" = "+this.options.parameterCharacter);var s=this._buildString(o,[a],{buildParameterized:t,formattingOptions:this._valueOptions[0][i]});e+=s.text,s.values.forEach(function(t){return r.push(t)})}return{text:"SET "+e,values:r}}}]),o}(),h.InsertFieldValueBlock=function(i){function o(){return r(this,o),t(this,(o.__proto__||Object.getPrototypeOf(o)).apply(this,arguments))}return e(o,h.AbstractSetFieldBlock),d(o,[{key:"set",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this._set(t,e,r)}},{key:"setFields",value:function(t,e){this._setFields(t,e)}},{key:"setFieldsRows",value:function(t,e){this._setFieldsRows(t,e)}},{key:"_toParamString",value:function(){for(var t=this,e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).buildParameterized,r=this._fields.map(function(e){return t._formatFieldName(e)}).join(", "),i=[],o=[],a=0;a<this._values.length;++a){i[a]="";for(var s=0;s<this._values[a].length;++s){var l=this._buildString(this.options.parameterCharacter,[this._values[a][s]],{buildParameterized:e,formattingOptions:this._valueOptions[a][s]});l.values.forEach(function(t){return o.push(t)}),i[a]=n(i[a],", "),i[a]+=l.text}}return{text:r.length?"("+r+") VALUES ("+i.join("), (")+")":"",values:o}}}]),o}(),h.InsertFieldsFromQueryBlock=function(n){function i(e){r(this,i);var n=t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return n._fields=[],n._query=null,n}return e(i,h.Block),d(i,[{key:"fromQuery",value:function(t,e){var r=this;this._fields=t.map(function(t){return r._sanitizeField(t)}),this._query=this._sanitizeBaseBuilder(e)}},{key:"_toParamString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e="",r=[];if(this._fields.length&&this._query){var n=this._query._toParamString({buildParameterized:t.buildParameterized,nested:!0}),i=n.text,o=n.values;e="("+this._fields.join(", ")+") "+this._applyNestingFormatting(i),r=o}return{text:e,values:r}}}]),i}(),h.DistinctBlock=function(n){function i(){return r(this,i),t(this,(i.__proto__||Object.getPrototypeOf(i)).apply(this,arguments))}return e(i,h.Block),d(i,[{key:"distinct",value:function(){this._useDistinct=!0}},{key:"_toParamString",value:function(){return{text:this._useDistinct?"DISTINCT":"",values:[]}}}]),i}(),h.GroupByBlock=function(n){function i(e){r(this,i);var n=t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return n._groups=[],n}return e(i,h.Block),d(i,[{key:"group",value:function(t){this._groups.push(this._sanitizeField(t))}},{key:"_toParamString",value:function(){return{text:this._groups.length?"GROUP BY "+this._groups.join(", "):"",values:[]}}}]),i}(),h.AbstractVerbSingleValueBlock=function(n){function i(e){r(this,i);var n=t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return n._value=null,n}return e(i,h.Block),d(i,[{key:"_setValue",value:function(t){this._value=null!==t?this._sanitizeLimitOffset(t):t}},{key:"_toParamString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=null!==this._value?this.options.verb+" "+this.options.parameterCharacter:"",r=null!==this._value?[this._value]:[];return this._buildString(e,r,t)}}]),i}(),h.OffsetBlock=function(n){function o(e){return r(this,o),t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,i({},e,{verb:"OFFSET"})))}return e(o,h.AbstractVerbSingleValueBlock),d(o,[{key:"offset",value:function(t){this._setValue(t)}}]),o}(),h.LimitBlock=function(n){function o(e){return r(this,o),t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,i({},e,{verb:"LIMIT"})))}return e(o,h.AbstractVerbSingleValueBlock),d(o,[{key:"limit",value:function(t){this._setValue(t)}}]),o}(),h.AbstractConditionBlock=function(n){function i(e){r(this,i);var n=t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return n._conditions=[],n}return e(i,h.Block),d(i,[{key:"_condition",value:function(t){t=this._sanitizeExpression(t);for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];this._conditions.push({expr:t,values:r||[]})}},{key:"_toParamString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=[],r=[],n=!0,i=!1,o=void 0;try{for(var a,s=this._conditions[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var l=a.value,u=l.expr,c=l.values,f=h.isSquelBuilder(u)?u._toParamString({buildParameterized:t.buildParameterized}):this._buildString(u,c,{buildParameterized:t.buildParameterized});f.text.length&&e.push(f.text),f.values.forEach(function(t){return r.push(t)})}}catch(t){i=!0,o=t}finally{try{!n&&s.return&&s.return()}finally{if(i)throw o}}return e.length&&(e=e.join(") AND (")),{text:e.length?this.options.verb+" ("+e+")":"",values:r}}}]),i}(),h.WhereBlock=function(n){function o(e){return r(this,o),t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,i({},e,{verb:"WHERE"})))}return e(o,h.AbstractConditionBlock),d(o,[{key:"where",value:function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];this._condition.apply(this,[t].concat(r))}}]),o}(),h.HavingBlock=function(n){function o(e){return r(this,o),t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,i({},e,{verb:"HAVING"})))}return e(o,h.AbstractConditionBlock),d(o,[{key:"having",value:function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];this._condition.apply(this,[t].concat(r))}}]),o}(),h.OrderByBlock=function(i){function o(e){r(this,o);var n=t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return n._orders=[],n}return e(o,h.Block),d(o,[{key:"order",value:function(t,e){t=this._sanitizeField(t),"string"!=typeof e&&(void 0===e?e="ASC":null!==e&&(e=e?"ASC":"DESC"));for(var r=arguments.length,n=Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];this._orders.push({field:t,dir:e,values:n||[]})}},{key:"_toParamString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e="",r=[],i=!0,o=!1,s=void 0;try{for(var l,u=this._orders[Symbol.iterator]();!(i=(l=u.next()).done);i=!0){var c=l.value,h=c.field,f=c.dir,d=c.values;e=n(e,", ");var p=this._buildString(h,d,{buildParameterized:t.buildParameterized});e+=p.text,a(p.values)&&p.values.forEach(function(t){return r.push(t)}),null!==f&&(e+=" "+f)}}catch(t){o=!0,s=t}finally{try{!i&&u.return&&u.return()}finally{if(o)throw s}}return{text:e.length?"ORDER BY "+e:"",values:r}}}]),o}(),h.JoinBlock=function(i){function o(e){r(this,o);var n=t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return n._joins=[],n}return e(o,h.Block),d(o,[{key:"join",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"INNER";t=this._sanitizeTable(t,!0),e=e?this._sanitizeTableAlias(e):e,r=r?this._sanitizeExpression(r):r,this._joins.push({type:n,table:t,alias:e,condition:r})}},{key:"left_join",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.join(t,e,r,"LEFT")}},{key:"right_join",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.join(t,e,r,"RIGHT")}},{key:"outer_join",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.join(t,e,r,"OUTER")}},{key:"left_outer_join",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.join(t,e,r,"LEFT OUTER")}},{key:"full_join",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.join(t,e,r,"FULL")}},{key:"cross_join",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.join(t,e,r,"CROSS")}},{key:"_toParamString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e="",r=[],i=!0,o=!1,a=void 0;try{for(var s,l=this._joins[Symbol.iterator]();!(i=(s=l.next()).done);i=!0){var u=s.value,c=u.type,f=u.table,d=u.alias,p=u.condition;e=n(e,this.options.separator);var _=void 0;if(h.isSquelBuilder(f)){var v=f._toParamString({buildParameterized:t.buildParameterized,nested:!0});v.values.forEach(function(t){return r.push(t)}),_=v.text}else _=this._formatTableName(f);if(e+=c+" JOIN "+_,d&&(e+=" "+this._formatTableAlias(d)),p){e+=" ON ";var y=void 0;y=h.isSquelBuilder(p)?p._toParamString({buildParameterized:t.buildParameterized}):this._buildString(p,[],{buildParameterized:t.buildParameterized}),e+=this._applyNestingFormatting(y.text),y.values.forEach(function(t){return r.push(t)})}}}catch(t){o=!0,a=t}finally{try{!i&&l.return&&l.return()}finally{if(o)throw a}}return{text:e,values:r}}}]),o}(),h.UnionBlock=function(i){function o(e){r(this,o);var n=t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return n._unions=[],n}return e(o,h.Block),d(o,[{key:"union",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"UNION";t=this._sanitizeTable(t),this._unions.push({type:e,table:t})}},{key:"union_all",value:function(t){this.union(t,"UNION ALL")}},{key:"_toParamString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e="",r=[],i=!0,o=!1,a=void 0;try{for(var s,l=this._unions[Symbol.iterator]();!(i=(s=l.next()).done);i=!0){var u=s.value,c=u.type,f=u.table;e=n(e,this.options.separator);var d=void 0;if(f instanceof h.BaseBuilder){var p=f._toParamString({buildParameterized:t.buildParameterized,nested:!0});d=p.text,p.values.forEach(function(t){return r.push(t)})}else e=this._formatTableName(f);e+=c+" "+d}}catch(t){o=!0,a=t}finally{try{!i&&l.return&&l.return()}finally{if(o)throw a}}return{text:e,values:r}}}]),o}(),h.QueryBuilder=function(n){function o(e,n){r(this,o);var i=t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));i.blocks=n||[];var a=!0,s=!1,l=void 0;try{for(var u,c=i.blocks[Symbol.iterator]();!(a=(u=c.next()).done);a=!0){var h=u.value,f=h.exposedMethods();for(var d in f){var p=f[d];if(void 0!==i[d])throw new Error("Builder already has a builder method called: "+d);!function(t,e,r){i[d]=function(){for(var e=arguments.length,n=Array(e),o=0;o<e;o++)n[o]=arguments[o];return r.call.apply(r,[t].concat(n)),i}}(h,0,p)}}}catch(t){s=!0,l=t}finally{try{!a&&c.return&&c.return()}finally{if(s)throw l}}return i}return e(o,h.BaseBuilder),d(o,[{key:"registerValueHandler",value:function(t,e){var r=!0,n=!1,i=void 0;try{for(var a,s=this.blocks[Symbol.iterator]();!(r=(a=s.next()).done);r=!0)a.value.registerValueHandler(t,e)}catch(t){n=!0,i=t}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}return f(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"registerValueHandler",this).call(this,t,e),this}},{key:"updateOptions",value:function(t){this.options=i({},this.options,t);var e=!0,r=!1,n=void 0;try{for(var o,a=this.blocks[Symbol.iterator]();!(e=(o=a.next()).done);e=!0){var s=o.value;s.options=i({},s.options,t)}}catch(t){r=!0,n=t}finally{try{!e&&a.return&&a.return()}finally{if(r)throw n}}}},{key:"_toParamString",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e=i({},this.options,e);var r=this.blocks.map(function(r){return r._toParamString({buildParameterized:e.buildParameterized,queryBuilder:t})}),n=r.map(function(t){return t.text}),o=r.map(function(t){return t.values}),a=n.filter(function(t){return 0<t.length}).join(e.separator),s=[];if(o.forEach(function(t){return t.forEach(function(t){return s.push(t)})}),!e.nested&&e.numberedParameters){var l=void 0!==e.numberedParametersStartAt?e.numberedParametersStartAt:1,u=e.parameterCharacter.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");a=a.replace(new RegExp(u,"g"),function(){return""+e.numberedParametersPrefix+l++})}return{text:this._applyNestingFormatting(a,!!e.nested),values:s}}},{key:"clone",value:function(){var t=this.blocks.map(function(t){return t.clone()});return new this.constructor(this.options,t)}},{key:"getBlock",value:function(t){return this.blocks.filter(function(e){return e instanceof t})[0]}}]),o}(),h.Select=function(n){function i(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return r(this,i),n=n||[new h.StringBlock(e,"SELECT"),new h.FunctionBlock(e),new h.DistinctBlock(e),new h.GetFieldBlock(e),new h.FromTableBlock(e),new h.JoinBlock(e),new h.WhereBlock(e),new h.GroupByBlock(e),new h.HavingBlock(e),new h.OrderByBlock(e),new h.LimitBlock(e),new h.OffsetBlock(e),new h.UnionBlock(e)],t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,n))}return e(i,h.QueryBuilder),i}(),h.Update=function(n){function i(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return r(this,i),n=n||[new h.StringBlock(e,"UPDATE"),new h.UpdateTableBlock(e),new h.SetFieldBlock(e),new h.WhereBlock(e),new h.OrderByBlock(e),new h.LimitBlock(e)],t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,n))}return e(i,h.QueryBuilder),i}(),h.Delete=function(n){function o(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return r(this,o),n=n||[new h.StringBlock(e,"DELETE"),new h.TargetTableBlock(e),new h.FromTableBlock(i({},e,{singleTable:!0})),new h.JoinBlock(e),new h.WhereBlock(e),new h.OrderByBlock(e),new h.LimitBlock(e)],t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e,n))}return e(o,h.QueryBuilder),o}(),h.Insert=function(n){function i(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return r(this,i),n=n||[new h.StringBlock(e,"INSERT"),new h.IntoTableBlock(e),new h.InsertFieldValueBlock(e),new h.InsertFieldsFromQueryBlock(e)],t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,n))}return e(i,h.QueryBuilder),i}();var v={VERSION:"5.12.0",flavour:c,expr:function(t){return new h.Expression(t)},case:function(t,e){return new h.Case(t,e)},select:function(t,e){return new h.Select(t,e)},update:function(t,e){return new h.Update(t,e)},insert:function(t,e){return new h.Insert(t,e)},delete:function(t,e){return new h.Delete(t,e)},str:function(){var t=new h.FunctionBlock;return t.function.apply(t,arguments),t},rstr:function(){var t=new h.FunctionBlock({rawNesting:!0});return t.function.apply(t,arguments),t},registerValueHandler:h.registerValueHandler};return v.remove=v.delete,v.cls=h,v}var f=function t(e,r,n){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,r);if(void 0===i){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,r,n)}if("value"in i)return i.value;var a=i.get;if(void 0!==a)return a.call(n)},d=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_=h();return _.flavours={},_.useFlavour=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!t)return _;if(_.flavours[t]instanceof Function){var e=h(t);return _.flavours[t].call(null,e),e.flavours=_.flavours,e.useFlavour=_.useFlavour,e}throw new Error("Flavour not available: "+t)},_.flavours.mssql=function(o){var a=o.cls;a.DefaultQueryBuilderOptions.replaceSingleQuotes=!0,a.DefaultQueryBuilderOptions.autoQuoteAliasNames=!1,a.DefaultQueryBuilderOptions.numberedParametersPrefix="@",o.registerValueHandler(Date,function(t){return"'"+t.getUTCFullYear()+"-"+(t.getUTCMonth()+1)+"-"+t.getUTCDate()+" "+t.getUTCHours()+":"+t.getUTCMinutes()+":"+t.getUTCSeconds()+"'"}),a.MssqlLimitOffsetTopBlock=function(n){function i(n){r(this,i);var o=t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,n));o._limits=null,o._offsets=null;var s=function(t){t=this._sanitizeLimitOffset(t),this._parent._limits=t};return o.ParentBlock=function(n){function i(e){r(this,i);var n=t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e.options));return n._parent=e,n}return e(i,a.Block),i}(),o.LimitBlock=function(n){function i(e){r(this,i);var n=t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return n.limit=s,n}return e(i,o.ParentBlock),d(i,[{key:"_toParamString",value:function(){var t="";return this._parent._limits&&this._parent._offsets&&(t="FETCH NEXT "+this._parent._limits+" ROWS ONLY"),{text:t,values:[]}}}]),i}(),o.TopBlock=function(n){function i(e){r(this,i);var n=t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return n.top=s,n}return e(i,o.ParentBlock),d(i,[{key:"_toParamString",value:function(){var t="";return this._parent._limits&&!this._parent._offsets&&(t="TOP ("+this._parent._limits+")"),{text:t,values:[]}}}]),i}(),o.OffsetBlock=function(n){function i(){return r(this,i),t(this,(i.__proto__||Object.getPrototypeOf(i)).apply(this,arguments))}return e(i,o.ParentBlock),d(i,[{key:"offset",value:function(t){this._parent._offsets=this._sanitizeLimitOffset(t)}},{key:"_toParamString",value:function(){var t="";return this._parent._offsets&&(t="OFFSET "+this._parent._offsets+" ROWS"),{text:t,values:[]}}}]),i}(),o}return e(i,a.Block),d(i,[{key:"LIMIT",value:function(){return new this.LimitBlock(this)}},{key:"TOP",value:function(){return new this.TopBlock(this)}},{key:"OFFSET",value:function(){return new this.OffsetBlock(this)}}]),i}(),a.MssqlUpdateTopBlock=function(n){function i(e){r(this,i);var n=t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return n._limits=null,n.limit=n.top=function(t){n._limits=n._sanitizeLimitOffset(t)},n}return e(i,a.Block),d(i,[{key:"_toParamString",value:function(){return{text:this._limits?"TOP ("+this._limits+")":"",values:[]}}}]),i}(),a.MssqlInsertFieldValueBlock=function(n){function i(e){r(this,i);var n=t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return n._outputs=[],n}return e(i,a.InsertFieldValueBlock),d(i,[{key:"output",value:function(t){var e=this;"string"==typeof t?this._outputs.push("INSERTED."+this._sanitizeField(t)):t.forEach(function(t){e._outputs.push("INSERTED."+e._sanitizeField(t))})}},{key:"_toParamString",value:function(t){var e=f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"_toParamString",this).call(this,t);if(e.text.length&&0<this._outputs.length){var r="OUTPUT "+this._outputs.join(", ")+" ",n=e.text.indexOf("VALUES");e.text=e.text.substr(0,n)+r+e.text.substr(n)}return e}}]),i}(),a.MssqlUpdateDeleteOutputBlock=function(i){function o(e){r(this,o);var n=t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return n._outputs=[],n}return e(o,a.Block),d(o,[{key:"outputs",value:function(t){for(var e in t)this.output(e,t[e])}},{key:"output",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t=this._sanitizeField(t),e=e?this._sanitizeFieldAlias(e):e,this._outputs.push({name:this.options.forDelete?"DELETED."+t:"INSERTED."+t,alias:e})}},{key:"_toParamString",value:function(t){var e="";if(this._outputs.length){var r=!0,i=!1,o=void 0;try{for(var a,s=this._outputs[Symbol.iterator]();!(r=(a=s.next()).done);r=!0){var l=a.value;e=n(e,", "),e+=l.name,l.alias&&(e+=" AS "+this._formatFieldAlias(l.alias))}}catch(t){i=!0,o=t}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}e="OUTPUT "+e}return{text:e,values:[]}}}]),o}(),a.Select=function(n){function i(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;r(this,i);var o=new a.MssqlLimitOffsetTopBlock(e);return n=n||[new a.StringBlock(e,"SELECT"),new a.DistinctBlock(e),o.TOP(),new a.GetFieldBlock(e),new a.FromTableBlock(e),new a.JoinBlock(e),new a.WhereBlock(e),new a.GroupByBlock(e),new a.OrderByBlock(e),o.OFFSET(),o.LIMIT(),new a.UnionBlock(e)],t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,n))}return e(i,a.QueryBuilder),i}(),a.Update=function(n){function i(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return r(this,i),n=n||[new a.StringBlock(e,"UPDATE"),new a.MssqlUpdateTopBlock(e),new a.UpdateTableBlock(e),new a.SetFieldBlock(e),new a.MssqlUpdateDeleteOutputBlock(e),new a.WhereBlock(e)],t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,n))}return e(i,a.QueryBuilder),i}(),a.Delete=function(n){function o(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return r(this,o),n=n||[new a.StringBlock(e,"DELETE"),new a.TargetTableBlock(e),new a.FromTableBlock(i({},e,{singleTable:!0})),new a.JoinBlock(e),new a.MssqlUpdateDeleteOutputBlock(i({},e,{forDelete:!0})),new a.WhereBlock(e),new a.OrderByBlock(e),new a.LimitBlock(e)],t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e,n))}return e(o,a.QueryBuilder),o}(),a.Insert=function(n){function i(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return r(this,i),n=n||[new a.StringBlock(e,"INSERT"),new a.IntoTableBlock(e),new a.MssqlInsertFieldValueBlock(e),new a.InsertFieldsFromQueryBlock(e)],t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,n))}return e(i,a.QueryBuilder),i}()},_.flavours.mysql=function(i){var o=i.cls;o.MysqlOnDuplicateKeyUpdateBlock=function(i){function a(){return r(this,a),t(this,(a.__proto__||Object.getPrototypeOf(a)).apply(this,arguments))}return e(a,o.AbstractSetFieldBlock),d(a,[{key:"onDupUpdate",value:function(t,e,r){this._set(t,e,r)}},{key:"_toParamString",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e="",r=[],i=0;i<this._fields.length;++i){e=n(e,", ");var o=this._fields[i],a=this._values[0][i],s=this._valueOptions[0][i];if(void 0===a)e+=o;else{var l=this._buildString(o+" = "+this.options.parameterCharacter,[a],{buildParameterized:t.buildParameterized,formattingOptions:s});e+=l.text,l.values.forEach(function(t){return r.push(t)})}}return{text:e.length?"ON DUPLICATE KEY UPDATE "+e:"",values:r}}}]),a}(),o.Insert=function(n){function i(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return r(this,i),n=n||[new o.StringBlock(e,"INSERT"),new o.IntoTableBlock(e),new o.InsertFieldValueBlock(e),new o.InsertFieldsFromQueryBlock(e),new o.MysqlOnDuplicateKeyUpdateBlock(e)],t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,n))}return e(i,o.QueryBuilder),i}(),o.Replace=function(n){function i(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return r(this,i),n=n||[new o.StringBlock(e,"REPLACE"),new o.IntoTableBlock(e),new o.InsertFieldValueBlock(e),new o.InsertFieldsFromQueryBlock(e)],t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,n))}return e(i,o.QueryBuilder),i}(),i.replace=function(t,e){return new o.Replace(t,e)}},_.flavours.postgres=function(o){var s=o.cls;s.DefaultQueryBuilderOptions.numberedParameters=!0,s.DefaultQueryBuilderOptions.numberedParametersStartAt=1,s.DefaultQueryBuilderOptions.autoQuoteAliasNames=!1,s.DefaultQueryBuilderOptions.useAsForTableAliasNames=!0,s.PostgresOnConflictKeyUpdateBlock=function(i){function o(){return r(this,o),t(this,(o.__proto__||Object.getPrototypeOf(o)).apply(this,arguments))}return e(o,s.AbstractSetFieldBlock),d(o,[{key:"onConflict",value:function(t,e){var r=this;this._onConflict=!0,t&&(a(t)||(t=[t]),this._dupFields=t.map(this._sanitizeField.bind(this)),e&&Object.keys(e).forEach(function(t){r._set(t,e[t])}))}},{key:"_toParamString",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e="",r=[],i=0;i<this._fields.length;++i){e=n(e,", ");var o=this._fields[i],a=this._values[0][i],s=this._valueOptions[0][i];if(void 0===a)e+=o;else{var l=this._buildString(o+" = "+this.options.parameterCharacter,[a],{buildParameterized:t.buildParameterized,formattingOptions:s});e+=l.text,l.values.forEach(function(t){return r.push(t)})}}var u={text:"",values:r};if(this._onConflict){var c=this._dupFields?"("+this._dupFields.join(", ")+") ":"",h=e.length?"UPDATE SET "+e:"NOTHING";u.text="ON CONFLICT "+c+"DO "+h}return u}}]),o}(),s.ReturningBlock=function(i){function o(e){r(this,o);var n=t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return n._fields=[],n}return e(o,s.Block),d(o,[{key:"returning",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(e=e?this._sanitizeFieldAlias(e):e,t=this._sanitizeField(t),this._fields.filter(function(r){return r.name===t&&r.alias===e}).length)return this;this._fields.push({name:t,alias:e,options:r})}},{key:"_toParamString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=(t.queryBuilder,t.buildParameterized),r="",i=[],o=!0,a=!1,s=void 0;try{for(var l,u=this._fields[Symbol.iterator]();!(o=(l=u.next()).done);o=!0){var c=l.value;r=n(r,", ");var h=c.name,f=c.alias,d=c.options;if("string"==typeof h)r+=this._formatFieldName(h,d);else{var p=h._toParamString({nested:!0,buildParameterized:e});r+=p.text,p.values.forEach(function(t){return i.push(t)})}f&&(r+=" AS "+this._formatFieldAlias(f))}}catch(t){a=!0,s=t}finally{try{!o&&u.return&&u.return()}finally{if(a)throw s}}return{text:r.length>0?"RETURNING "+r:"",values:i}}}]),o}(),s.WithBlock=function(n){function i(e){r(this,i);var n=t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return n._tables=[],n}return e(i,s.Block),d(i,[{key:"with",value:function(t,e){this._tables.push({alias:t,table:e})}},{key:"_toParamString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=[],r=[],n=!0,i=!1,o=void 0;try{for(var a,s=this._tables[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var l=a.value,u=l.alias,c=l.table._toParamString({buildParameterized:t.buildParameterized,nested:!0});e.push(u+" AS "+c.text),c.values.forEach(function(t){return r.push(t)})}}catch(t){i=!0,o=t}finally{try{!n&&s.return&&s.return()}finally{if(i)throw o}}return{text:e.length?"WITH "+e.join(", "):"",values:r}}}]),i}(),s.DistinctOnBlock=function(n){function i(e){r(this,i);var n=t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return n._distinctFields=[],n}return e(i,s.Block),d(i,[{key:"distinct",value:function(){var t=this;this._useDistinct=!0;for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];r.forEach(function(e){t._distinctFields.push(t._sanitizeField(e))})}},{key:"_toParamString",value:function(){var t="";return this._useDistinct&&(t="DISTINCT",this._distinctFields.length&&(t+=" ON ("+this._distinctFields.join(", ")+")")),{text:t,values:[]}}}]),i}(),s.Select=function(n){function i(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return r(this,i),n=n||[new s.WithBlock(e),new s.StringBlock(e,"SELECT"),new s.FunctionBlock(e),new s.DistinctOnBlock(e),new s.GetFieldBlock(e),new s.FromTableBlock(e),new s.JoinBlock(e),new s.WhereBlock(e),new s.GroupByBlock(e),new s.HavingBlock(e),new s.OrderByBlock(e),new s.LimitBlock(e),new s.OffsetBlock(e),new s.UnionBlock(e)],t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,n))}return e(i,s.QueryBuilder),i}(),s.Insert=function(n){function i(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return r(this,i),n=n||[new s.WithBlock(e),new s.StringBlock(e,"INSERT"),new s.IntoTableBlock(e),new s.InsertFieldValueBlock(e),new s.InsertFieldsFromQueryBlock(e),new s.PostgresOnConflictKeyUpdateBlock(e),new s.ReturningBlock(e)],t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,n))}return e(i,s.QueryBuilder),i}(),s.Update=function(n){function i(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return r(this,i),n=n||[new s.WithBlock(e),new s.StringBlock(e,"UPDATE"),new s.UpdateTableBlock(e),new s.SetFieldBlock(e),new s.FromTableBlock(e),new s.WhereBlock(e),new s.OrderByBlock(e),new s.LimitBlock(e),new s.ReturningBlock(e)],t(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,n))}return e(i,s.QueryBuilder),i}(),s.Delete=function(n){function o(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return r(this,o),n=n||[new s.WithBlock(e),new s.StringBlock(e,"DELETE"),new s.TargetTableBlock(e),new s.FromTableBlock(i({},e,{singleTable:!0})),new s.JoinBlock(e),new s.WhereBlock(e),new s.OrderByBlock(e),new s.LimitBlock(e),new s.ReturningBlock(e)],t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e,n))}return e(o,s.QueryBuilder),o}()},_})}),QueryBuilder=t=>squel.useFlavour(t||"mysql");class Processor{constructor(t){if(void 0===t)throw new Error("A QueryBuilder object is required to initialize a Processor");this._qb=t}process(t,e,r,n){throw new Error("No process() method implemented for this class")}}const getFieldValue=(t,e,r)=>null!==t?void 0!==r[e.value]?e.alias:`${t}.${e.value}`:e.value;class FilterString{_handleQueryCall(t,e,r,n){const i=t.filter(t=>"QUERY"===t.type&&t.name===e.name)[0];if(void 0===i){let t=[];return e.params.forEach(e=>{e.type===Nodes.VARIABLE?t.push(resolveVariable(e.value,r)):t.push(e.value)}),{text:`${e.name}(${t.join(", ")})`,variables:[]}}const{variables:o}=i,a={};return o.forEach((t,n)=>{const i=e.params[n];i.type===Nodes.VARIABLE?a[t.name]=resolveVariable(i.value,r):a[t.name]=i.value}),{text:"?",variables:[QueryProcessor$1(n).process(t,i,{variables:a})]}}_handleOperation(t,e,r,n,i,o){const a=r.a,s=r.op,l=r.b,u=this._buildString(t,e,a,n,!0,i,o),c=this._buildString(t,null,l,n,!1,i,o);return{text:`${u.text} ${s} ${c.text}`,variables:[...u.variables,...c.variables]}}_buildString(t,e,r,n,i,o,a){let s=null;switch(r.type){case Nodes.OPERATION:s=this._handleOperation(t,e,r,n,o,a);break;case Nodes.VARIABLE:s=this._handleVariable(r,n);break;case Nodes.BUILT_IN:s=this._handleBuiltIn(r);break;case Nodes.QUERY_CALL:s=this._handleQueryCall(t,r,n,a);break;case Nodes.RAW_TEXT:s=this._handleLeftSide(e,r,o);break;default:s=i?this._handleLeftSide(e,r,o):this._handleText(e,r,o)}return s}constructor(t,e,r,n,i,o){_initialiseProps.call(this),this._string=this._buildString(t,e,r,n,!1,i||{},o)}}var _initialiseProps=function(){this._handleText=((t,e,r)=>({text:"?",variables:[getFieldValue(t,e,r)]})),this._handleLeftSide=((t,e,r)=>({text:getFieldValue(t,e,r),variables:[]})),this._handleBuiltIn=(t=>({text:t.value,variables:[]})),this._handleVariable=((t,e)=>({text:"?",variables:[resolveVariable(t.value,e)]})),this.toString=(()=>this._string)},asyncGenerator=function(){function t(t){this.value=t}function e(e){function r(i,o){try{var a=e[i](o),s=a.value;s instanceof t?Promise.resolve(s.value).then(function(t){r("next",t)},function(t){r("throw",t)}):n(a.done?"return":"normal",a.value)}catch(t){n("throw",t)}}function n(t,e){switch(t){case"return":i.resolve({value:e,done:!0});break;case"throw":i.reject(e);break;default:i.resolve({value:e,done:!1})}(i=i.next)?r(i.key,i.arg):o=null}var i,o;this._invoke=function(t,e){return new Promise(function(n,a){var s={key:t,arg:e,resolve:n,reject:a,next:null};o?o=o.next=s:(i=o=s,r(t,e))})},"function"!=typeof e.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(e.prototype[Symbol.asyncIterator]=function(){return this}),e.prototype.next=function(t){return this._invoke("next",t)},e.prototype.throw=function(t){return this._invoke("throw",t)},e.prototype.return=function(t){return this._invoke("return",t)},{wrap:function(t){return function(){return new e(t.apply(this,arguments))}},await:function(e){return new t(e)}}}(),_extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t},objectWithoutProperties=function(t,e){var r={};for(var n in t)e.indexOf(n)>=0||Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n]);return r};class Helpers{static getFieldsFromNode(t){const{type:e,table:r,name:n,nodes:i}=t;return i.filter(t=>t.type===Nodes.FIELD).map(t=>_extends({},t,{name:e===Nodes.JOIN?`${r}.${t.name}`:`${n}.${t.name}`}))}static getFieldsFromOperationString(t,e,r){if(t.type===Nodes.OPERATION){const n=t.a;return r=[...r,...this.getFieldsFromOperationString(n,e,r)]}return t.type===Nodes.VARIABLE?[e[t]]:[t]}static buildFilterString(t,e,r,n,i,o){return new FilterString(t,e,r,n,i,o).toString()}static applyWhereStatement(t,e,r,n){const{params:i}=e,o=i.map(e=>Helpers.buildFilterString(t,null,e,r,[],n.flavour));o.length>0&&(n=n.where(o.map(t=>t.text).join(" AND "),...o.map(t=>t.variables).reduce((t,e)=>t.concat(e))))}static interpolateVariables(t,e){const r=/(\s+\?\s+)|(^\?\s+)|(\s+\?$)/g;let n=0,i=0,o="",a=r.exec(t);for(;null!==a;){const s=e[n];if(void 0===s)throw new Error("Missing variable. Cannot interpolate.");o+=`${t.substring(i,a.index)} ${s}`,i=a.index+(0===a.index?1:2),n++,a=r.exec(t)}return o+=t.substring(i,t.length)}}class JoinProcessor extends Processor{_applyFields(t,e,r){e.forEach(e=>{e.alias?r.includes(e.alias)?t.field(e.alias):(t.field(e.name,e.alias),r.push(e.alias)):t.field(e.name)})}_getOnString(t,e,r,n){const{on:i}=e;return i.map(i=>{const o=Helpers.buildFilterString(t,e.table,i,r,n,this._qb.flavour);return Helpers.interpolateVariables(o.text,o.variables)}).join(" AND ")}_addAllFieldsAndJoins(t,e,r,n,i){const{table:o,on:a}=e,s=Helpers.getFieldsFromNode(e),l=this._getAllSubjoins(t,e,r,n),u=l.length>0?l.map(t=>t.fields).reduce((t,e)=>t.concat(e)):[];s.forEach(t=>{if(t.value)throw new Error("Values cannot be assigned to fields in a query document");i.field(t.name)}),l.forEach(t=>this._applyFields(i,t.fields,n));const c=s.map(t=>t.value);return a.map(t=>Helpers.getFieldsFromOperationString(t,r,[])).reduce((t,e)=>t.concat(e)).forEach(t=>{const e=`${o}.${t.value}`;c.includes(e)||i.field(e)}),l.forEach(t=>i.join(t.qb,t.table,t.on)),[...s,...u]}_getAllSubjoins(t,e,r,n){const{nodes:i}=e,o=[];return i.filter(t=>t.type===Nodes.JOIN).forEach(e=>{o.push(this._processJoin(t,e,r,n))}),o}_processJoin(t,e,r,n){const{table:i}=e,o=this._getOnString(t,e,r,n),a=this._qb.select().from(i);return{qb:a,table:i,fields:this._addAllFieldsAndJoins(t,e,r,n,a),on:o}}process(t,e,r,n){const i=[],o=e.nodes.filter(t=>t.type===Nodes.JOIN).map(e=>this._processJoin(t,e,r,i));return o.forEach(t=>this._applyFields(n,t.fields,i)),o.forEach(t=>n.join(t.qb,t.table,t.on)),n}}var JoinProcessor$1=t=>new JoinProcessor(t);class QueryProcessor extends Processor{_addTableFields(t,e){Helpers.getFieldsFromNode(t).forEach(t=>{if(t.value)throw new Error("Values cannot be assigned to fields in a query document");t.alias?e.field(t.name,t.alias):e.field(t.name)})}_addConfigOptions(t,e){const{orderBy:r,descending:n,groupBy:i,limit:o,offset:a}=t,s=t=>void 0!==t&&null!==t;s(i)&&e.group(i),s(r)&&e.order(r,!n),s(a)&&e.offset(a),s(o)&&e.limit(o)}_processTable(t,e,r,n){const{name:i}=e;let o=this._qb.select().from(i);return this._addTableFields(e,o),o=JoinProcessor$1(this._qb).process(t,e,r,o),Helpers.applyWhereStatement(t,e,r,o),this._addConfigOptions(n,o),o}process(t,e,r,n=this._qb){const{variables:i,nodes:o}=e;let{variables:a}=r,s=objectWithoutProperties(r,["variables"]);if(a=Object.assign({},a),e.type!==Nodes.QUERY)throw new Error("Only a query document node can be passed to a QueryProcessor");i.forEach(t=>{if(a&&a.hasOwnProperty(t.name))a[t.name]={value:a[t.name],required:t.required};else if(t.required)throw new Error(`Missing required variable ${t.name}`)});const l=o.filter(t=>t.type===Nodes.TABLE);if(l.length<1)throw new Error("Query must contain at least one table");return l.forEach(e=>{n=this._processTable(t,e,a||{},s)}),n}}var QueryProcessor$1=t=>new QueryProcessor(QueryBuilder(t));class MutationProcessor extends Processor{_addTableFields(t,e,r){let n=0;if(t.nodes.filter(t=>t.type===Nodes.FIELD).forEach(t=>{this._verifyField(t);try{switch(t.value.type){case Nodes.VARIABLE:const i=t.value.value,o=e[i];void 0!==o&&(r.set(t.name,o.value),n++);break;case Nodes.RAW_TEXT:r.set(t.name,this._qb.str(t.value.value)),n++;break;default:r.set(t.name,t.value.value),n++}}catch(e){console.error(`Value \`${t.value.value}\` for field \`${t.name}\` is invalid`)}}),0===n)throw new Error("At least one field must be set in a mutation")}_verifyField(t){if(t.alias)throw new Error("Aliases not allowed in mutations");if(null===t.value)throw new Error(`Value required for field '${t.name}'`);return!0}_processInsert(t,e,r,n){const{name:i}=e,{returning:o}=n;let a=this._qb.insert().into(i);return this._addTableFields(e,r,a),o&&a.returning(o),a}_processUpdate(t,e,r,n){const{name:i}=e,{descending:o,orderBy:a,limit:s}=n;let l=this._qb.update().table(i);return this._addTableFields(e,r,l),Helpers.applyWhereStatement(t,e,r,l),void 0!==a&&null!==a&&l.order(a,!o),void 0!==s&&null!==s&&l.limit(s),l}_processTable(t,e,r,n){const{params:i,nodes:o}=e;if(o.filter(t=>t.type===Nodes.JOIN).length>0)throw new Error("Join statements are not allowed in mutations");let a;return a=i.length>0?this._processUpdate(t,e,r,n):this._processInsert(t,e,r,n)}process(t,e,r,n=this._qb){const{variables:i,nodes:o}=e;let{variables:a}=r,s=objectWithoutProperties(r,["variables"]);if(a=Object.assign({},a),e.type!==Nodes.MUTATION)throw new Error("Only a mutation document node can be passed to a MutationProcessor");i.forEach(t=>{if(a&&a.hasOwnProperty(t.name))a[t.name]={value:a[t.name],required:t.required};else if(t.required)throw new Error(`Missing required variable ${t.name}`)});const l=o.filter(t=>t.type===Nodes.TABLE);if(l.length<1)throw new Error("Mutations must contain at least one table");return l.forEach(e=>{n=this._processTable(t,e,a||{},s)}),n}}var MutationProcessor$1=t=>new MutationProcessor(QueryBuilder(t));const getFunctionArgs=t=>{let e=null,r={},n=!1;switch(t.length){case 1:r=t[0];break;case 2:"string"==typeof t[0]?(e=t[0],r=t[1]):(r=t[0],n=t[1]);break;case 3:e=t[0],r=t[1],n=t[2]}return{name:e,config:r,as_string:n}},getEntryPoint=(t,e)=>{const{name:r}=t,n=null!==r?e.findIndex(t=>t.name===r):e.length-1;if(null!==r&&n<0)throw new Error(`Could not find document \`${r}\``);return e[n]},getProcessedDocument=(t,e,r,n)=>{let{config:i,as_string:o}=n,a=null;switch(t.type){case Nodes.QUERY:a=QueryProcessor$1(r).process(e,t,i);break;case Nodes.MUTATION:a=MutationProcessor$1(r).process(e,t,i);break;default:throw new Error("Unrecognized document type")}if(null!==a)return o?a.toString():a.toParam();throw new Error("An error occurred processing the document")},getFunction=(t,e)=>(function(){const r=getFunctionArgs(Array.from(arguments)),n=getEntryPoint(r,e);return getProcessedDocument(n,e,t,r)}),dql=t=>(function(e){const r=Array.from(arguments),n=r[0];let i="string"==typeof n?n:n[0];for(let t=1;t<r.length;t++)i+=r[t],i+=n[t];const o=_parser.parse(i);return getFunction(t,o)}),postgres=dql("postgres"),mysql=dql("mysql"),mssql=dql("mssql");exports.postgres=postgres,exports.mysql=mysql,exports.mssql=mssql;
